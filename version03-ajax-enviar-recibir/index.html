<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link rel="stylesheet" href="styles.css">
   <title>Chat - UAM</title>
</head>
<body onload="carga()">
   <div id="messages" class="messages">
      <template id="message_template">
         <div class="message sent">
            <div class="metadata">
               <p class="author">Author</p>
               <p class="date">Date</p>
            </div>
            <div class="content">
               Lorem ipsum dolor sit amet consectetur adipisicing elit. A saepe numquam blanditiis eos eveniet quis iusto ex minima cum alias! Ducimus nobis vero quae voluptatem ipsam temporibus in doloribus adipisci?
            </div>
         </div> 
      </template>
   </div>
   <form>
      <div class="write-message">
         <label for="username">Username: <input id="username" name="username" type="text"> </label>
         <textarea id="message-body" class="message-body" placeholder="255 chars max lenght" name="message-body" rows="5" minlength="1" maxlength="255"></textarea>
         <button class="button" id="button-send" type="button" onclick="enviar(this.form)">Send</button>
      </div>
   </form>

   <script src="script.js"></script>
   <script>
      async function carga(){
         let respuesta = await fetch("backend/load.php");
         let mensajes = await respuesta.json();
         
         // Los atributos ("class", "href", "id", etc.) se mapean a propiedades de los objetos de js (objecto.className,objeto.href, objecto.id)
         // El atributo (html) se llama class, la propiedad asociada (js) se llama className
         // author.className = cosa;
         //  es equivalente a 
         // author.setAttribute("class", cosa);
         
         let padre = document.getElementById("messages");
         let plantilla = document.getElementById("message_template");
         for(let mensaje of mensajes) {
            let copia = plantilla.content.cloneNode(true);
            copia.querySelector(".author").textContent = mensaje.autor;
            copia.querySelector(".date").textContent = mensaje.fecha;
            copia.querySelector(".content").textContent = mensaje.cuerpo;
            padre.appendChild(copia);
         }
      }

      async function enviar(forma) {
         if(!forma.checkValidity()){ // reportValidity( ) sí regaña
            return;
         }

         let respuesta = await fetch("backend/sent.php", {
            "body": new FormData(forma),
            "method": "POST" // Lo normal es que las formas lleguen usando POST
         });
         let texto = await respuesta.text( ); // Regresa la fecha en caso de NO errores

         if(texto != "vacio-usuario-mensaje" && texto != "vacio-usuario" && texto != "vacio-mensaje"){
            let padre = document.getElementById("messages");
            let plantilla = document.getElementById("message_template");
            let f_data = new FormData(forma);

            let copia = plantilla.content.cloneNode(true);
            copia.querySelector(".author").textContent = f_data.get("username");
            copia.querySelector(".date").textContent = texto;
            copia.querySelector(".content").textContent = f_data.get("message-body");
            padre.appendChild(copia);
         }

      }
   </script>
</body>
</html>